<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#ff85a2">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PowerPuffFit">
<link rel="apple-touch-icon" href="../images/logo.png">
    <title>Dashboard - PowerPufFit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
    :root {
        --primary-color: #ff85a2;
        --secondary-color: #ffacc7;
        --accent-color: #ffd6e0;
        --dark-color: #8a2f5a;
        --light-color: #fff0f6;
        --text-dark: #5a2a3a;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #fff0f6 0%, #ffeef5 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        color: var(--text-dark);
        overflow-x: hidden;
    }

    /* Layout Principal */
    .app-container {
        display: flex;
        min-height: 100vh;
    }

    /* Sidebar - Actualizado para coincidir con inventario */
    .sidebar {
        background: linear-gradient(180deg, var(--primary-color) 0%, var(--dark-color) 100%);
        color: white;
        width: 280px;
        min-height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 1000;
        transition: transform 0.3s ease;
        box-shadow: 3px 0 15px rgba(138, 47, 90, 0.2);
    }

    .main-content {
        margin-left: 280px;
        padding: 20px;
        min-height: 100vh;
        transition: all 0.3s ease;
        width: calc(100% - 280px);
        background: linear-gradient(135deg, #fff0f6 0%, #ffeef5 100%);
    }

    .sidebar-brand {
        padding: 1.5rem;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-brand img {
        height: 50px;
        border-radius: 50%;
        margin-bottom: 10px;
    }

    .sidebar-brand h5 {
        margin-bottom: 0;
        font-weight: 600;
    }

    .sidebar-brand small {
        opacity: 0.8;
        font-size: 0.8rem;
    }

    .nav-link {
        color: white !important;
        padding: 0.8rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
    }

    .nav-link:hover, .nav-link.active {
        background-color: rgba(255, 255, 255, 0.1);
        padding-left: 2rem;
    }

    .nav-link i {
        width: 20px;
        margin-right: 10px;
        text-align: center;
    }

    .nav-link.text-danger:hover {
        background-color: rgba(220, 53, 69, 0.2);
    }

    /* Bot√≥n toggle para m√≥vil */
    .sidebar-toggle {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1100;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 1.2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    .overlay.active {
        display: block;
    }

    /* ===== RESPONSIVE DESIGN ===== */

    /* Tablets */
    @media (max-width: 992px) {
        .sidebar {
            transform: translateX(-100%);
            width: 280px;
        }
        
        .sidebar.active {
            transform: translateX(0);
            box-shadow: 5px 0 25px rgba(0,0,0,0.3);
        }
        
        .main-content {
            margin-left: 0 !important;
            width: 100% !important;
            padding: 15px;
        }
        
        .sidebar-toggle {
            display: block;
        }
        
        .navbar-top {
            margin-top: 60px; /* Espacio para el bot√≥n toggle */
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
    }

    /* Tablets peque√±as y m√≥viles grandes */
    @media (max-width: 768px) {
        .main-content {
            padding: 15px;
        }
        
        .navbar-top {
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .quick-actions {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .stat-card {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .chart-container, .activity-list {
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 1.2rem;
        }
        
        .activity-item {
            padding: 1rem 0;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            margin-right: 1rem;
            font-size: 1rem;
        }
    }

    /* M√≥viles */
    @media (max-width: 576px) {
        .main-content {
            padding: 10px;
        }
        
        .navbar-top {
            padding: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .quick-actions {
            grid-template-columns: 1fr;
            gap: 0.8rem;
        }
        
        .stat-number {
            font-size: 1.8rem;
        }
        
        .stat-icon {
            font-size: 2.2rem;
        }
        
        .section-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .activity-item {
            padding: 0.8rem 0;
        }
        
        .activity-title {
            font-size: 0.9rem;
        }
        
        .activity-time {
            font-size: 0.8rem;
        }
        
        .action-btn {
            padding: 1.2rem 0.8rem;
        }
        
        .action-btn i {
            font-size: 1.5rem;
        }
        
        .action-btn span {
            font-size: 0.9rem;
        }
        
        .chart-container, .activity-list {
            padding: 1rem;
        }
        
        .chart-container canvas {
            max-height: 200px;
        }
        
        .user-info {
            flex-direction: column;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
        }
    }

    /* M√≥viles muy peque√±os */
    @media (max-width: 480px) {
        .main-content {
            padding: 8px;
        }
        
        .navbar-top {
            padding: 0.8rem;
        }
        
        .chart-container, .activity-list {
            padding: 0.8rem;
        }
        
        .stat-card {
            padding: 1.2rem;
        }
        
        .stat-number {
            font-size: 1.6rem;
        }
        
        .stat-icon {
            font-size: 2rem;
        }
        
        .sidebar-toggle {
            padding: 8px 10px;
            font-size: 1.1rem;
        }
    }

    /* Resto de estilos del dashboard */
    .navbar-top {
        background: white;
        box-shadow: 0 2px 15px rgba(138, 47, 90, 0.1);
        border-radius: 15px;
        margin-bottom: 2rem;
        padding: 1.2rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        position: relative;
        z-index: 1;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.3rem;
        box-shadow: 0 4px 12px rgba(138, 47, 90, 0.2);
        flex-shrink: 0;
    }

    /* Cards */
    .stat-card {
        background: white;
        border-radius: 20px;
        padding: 1.8rem;
        box-shadow: 0 8px 25px rgba(138, 47, 90, 0.1);
        transition: all 0.3s ease;
        border: none;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 35px rgba(138, 47, 90, 0.15);
    }

    .stat-icon {
        font-size: 2.8rem;
        margin-bottom: 1.2rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-number {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .stat-label {
        color: var(--text-dark);
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
    }

    /* Charts */
    .chart-container {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 8px 25px rgba(138, 47, 90, 0.1);
        margin-bottom: 2rem;
        height: 100%;
    }

    .section-title {
        color: var(--dark-color);
        font-weight: 700;
        margin-bottom: 1.8rem;
        font-size: 1.5rem;
        position: relative;
        padding-bottom: 10px;
    }

    .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        border-radius: 2px;
    }

    /* Activity List */
    .activity-list {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 8px 25px rgba(138, 47, 90, 0.1);
        height: 100%;
    }

    .activity-item {
        display: flex;
        align-items: center;
        padding: 1.2rem 0;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s ease;
    }

    .activity-item:hover {
        background: #f8f9fa;
        border-radius: 10px;
        padding-left: 10px;
        padding-right: 10px;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1.2rem;
        color: var(--primary-color);
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
        min-width: 0;
    }

    .activity-title {
        font-weight: 600;
        margin-bottom: 0.3rem;
        color: var(--dark-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .activity-time {
        font-size: 0.85rem;
        color: #888;
    }

    /* Quick Actions */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.2rem;
        margin-bottom: 2.5rem;
    }

    .action-btn {
        background: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        padding: 1.5rem 1rem;
        border-radius: 15px;
        text-align: center;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.8rem;
        box-shadow: 0 4px 15px rgba(255, 133, 162, 0.1);
    }

    .action-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(255, 133, 162, 0.3);
    }

    .action-btn i {
        font-size: 1.8rem;
    }

    /* Status Alerts */
    .status-alert {
        border-radius: 12px;
        border: none;
        margin-bottom: 1rem;
    }

    /* Mejoras de accesibilidad */
    .nav-link:focus {
        outline: 2px solid white;
        outline-offset: 2px;
    }

    .action-btn:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    .btn:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    /* Loading states */
    .loading {
        opacity: 0.7;
        pointer-events: none;
    }

    /* Status Alerts responsivos */
    @media (max-width: 576px) {
        .status-alert {
            font-size: 0.85rem;
            padding: 0.75rem;
        }
        
        .status-alert .fs-4 {
            font-size: 1.2rem !important;
        }
    }

    /* Asegurar que las im√°genes sean responsivas */
    img {
        max-width: 100%;
        height: auto;
    }

    /* Mejorar visualizaci√≥n de tablas en m√≥vil */
    .table-responsive {
        border-radius: 10px;
    }

    /* Ajustes espec√≠ficos para gr√°ficos */
    .chart-container canvas {
        max-width: 100%;
        height: auto !important;
    }

    /* Prevenir scroll cuando el sidebar est√° abierto en m√≥vil */
    body.sidebar-open {
        overflow: hidden;
    }
    /* Mejoras para PWA */
.pwa-mode .sidebar-toggle {
    top: env(safe-area-inset-top, 15px);
}

@media (display-mode: standalone) {
    body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    .navbar-top {
        margin-top: calc(env(safe-area-inset-top) + 10px);
    }
}

/* Prevenir zoom en inputs en iOS */
@media (max-width: 768px) {
    input, select, textarea {
        font-size: 16px !important;
    }
}

/* Mejorar botones para touch */
.btn, .nav-link, .action-btn {
    touch-action: manipulation;
}

/* Optimizar scroll para PWA */
body {
    -webkit-overflow-scrolling: touch;
}

/* Safe areas para notches */
.sidebar {
    padding-top: env(safe-area-inset-top);
}

/* Estilos para el logo en el user-avatar */
.user-logo {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(138, 47, 90, 0.3);
}

/* Asegurar que el contenedor del avatar mantenga sus dimensiones */
.user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.3rem;
    box-shadow: 0 4px 12px rgba(138, 47, 90, 0.2);
    flex-shrink: 0;
    overflow: hidden; /* Importante para que la imagen no se salga */
}

/* Estilos responsivos para el logo */
@media (max-width: 576px) {
    .user-avatar {
        width: 40px;
        height: 40px;
    }
    
    .user-logo {
        border-width: 1px;
    }
}

</style>
</head>
<body>
    <!-- Bot√≥n para mostrar/ocultar sidebar en m√≥vil -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Overlay para m√≥vil -->
    <div class="overlay" id="overlay"></div>
    
    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar - Actualizado para coincidir con inventario -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <img src="images/logo.png" alt="Logo" height="50" class="rounded-circle mb-2">
                <h5>PowerPufFit</h5>
                <small>Dashboard</small>
            </div>
            
            <nav class="nav flex-column">
                <a class="nav-link" href="dashboard.html">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
                <a class="nav-link active" href="inventario.html">
                    <i class="fas fa-boxes me-2"></i>Inventario
                </a>
                <a class="nav-link" href="tienda.html">
                    <i class="fas fa-store me-2"></i>Tienda Online
                </a>
                <a class="nav-link" href="ventas.html">
                    <i class="fas fa-cash-register me-2"></i>Ventas
                </a>
                <a class="nav-link" href="clientes.html" >
                    <i class="fas fa-users me-2"></i>Gesti√≥n Clientes
                </a>
                <a class="nav-link" href="reportes.html">
                    <i class="fas fa-chart-bar me-2"></i>Reportes
                </a>
                <a class="nav-link text-danger mt-auto" href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Top Bar -->
            <div class="navbar-top">
                <div>
                    <h3 class="mb-0">Dashboard Principal</h3>
                    <small class="text-muted" id="currentDate">Cargando fecha...</small>
                </div>
                <div class="user-info">
    <div class="user-avatar" id="userAvatar">
        <img src="images/logo.png" alt="Logo PowerPuffFit" class="user-logo">
    </div>
    <div>
        <div class="fw-bold" id="userName">Usuario</div>
        <small class="text-muted" id="userStatus">activo</small>
    </div>
</div>
            </div>

            <!-- Welcome Message -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info status-alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-3 fs-4"></i>
                            <div>
                                <h5 class="alert-heading mb-1" id="welcomeTitle">Bienvenido al Dashboard</h5>
                                <p class="mb-0" id="welcomeMessage">Cargando informaci√≥n del sistema...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <a href="inventario.html" class="action-btn" id="addProductBtn">
                    <i class="fas fa-plus"></i>
                    <span>Agregar Producto</span>
                </a>
                <a href="ventas.html" class="action-btn" id="newSaleBtn">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Nueva Venta</span>
                </a>
                <a href="inventario.html" class="action-btn" id="viewInventoryBtn">
                    <i class="fas fa-box-open"></i>
                    <span>Gestionar Inventario</span>
                </a>
                <a href="reportes.html" class="action-btn" id="reportsBtn">
                    <i class="fas fa-file-alt"></i>
                    <span>Generar Reporte</span>
                </a>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-4 mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="stat-number" id="totalProductos">0</div>
                        <div class="stat-label">Total Productos</div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-number" id="totalVentas">0</div>
                        <div class="stat-label">Ventas del Mes</div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-number" id="ingresosTotales">$0</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-number" id="stockBajo">0</div>
                        <div class="stat-label">Stock Bajo</div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4">
                <div class="col-xl-8 col-lg-7">
                    <div class="chart-container">
                        <h4 class="section-title">Ventas de los √öltimos 7 D√≠as</h4>
                        <canvas id="salesChart" height="250"></canvas>
                    </div>
                </div>
                <div class="col-xl-4 col-lg-5">
                    <div class="chart-container">
                        <h4 class="section-title">Productos por Categor√≠a</h4>
                        <canvas id="categoryChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Activity & Low Stock -->
            <div class="row g-4 mt-4">
                <div class="col-lg-6">
                    <div class="activity-list">
                        <h4 class="section-title">Actividad Reciente</h4>
                        <div id="recentActivity">
                            <!-- Activity items will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="activity-list">
                        <h4 class="section-title">Productos con Stock Bajo</h4>
                        <div id="lowStockProducts">
                            <!-- Low stock products will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h4 class="section-title">Estado del Sistema</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h5><i class="fas fa-key me-2"></i>Firebase Auth Status</h5>
                                <div id="authStatus" class="alert alert-warning status-alert">
                                    <i class="fas fa-sync fa-spin me-2"></i>Verificando autenticaci√≥n...
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h5><i class="fas fa-database me-2"></i>Firestore Status</h5>
                                <div id="firestoreStatus" class="alert alert-warning status-alert">
                                    <i class="fas fa-sync fa-spin me-2"></i>Conectando a la base de datos...
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <button id="testAuthBtn" class="btn btn-primary me-2 mb-2">
                                <i class="fas fa-vial me-1"></i>Probar Autenticaci√≥n
                            </button>
                            <button id="testFirestoreBtn" class="btn btn-success me-2 mb-2">
                                <i class="fas fa-database me-1"></i>Probar Firestore
                            </button>
                            <button id="refreshDataBtn" class="btn btn-info mb-2">
                                <i class="fas fa-sync me-1"></i>Actualizar Datos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, limit, addDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDJIhyjLP2EEcg7RKgLHREmMosKA5cL6Qw",
            authDomain: "powerpuffit.firebaseapp.com",
            projectId: "powerpuffit",
            storageBucket: "powerpuffit.appspot.com",
            messagingSenderId: "450568163513",
            appId: "1:450568163513:web:ee8ccfa9fbfe1075d34b68"
        };

        class Dashboard {
            constructor() {
                this.app = initializeApp(firebaseConfig);
                this.db = getFirestore(this.app);
                this.auth = getAuth(this.app);
                this.init();
            }

            async init() {
                this.initEventListeners();
                this.updateCurrentDate();
                await this.checkAuth();
                await this.testFirestoreConnection();
                await this.loadStatistics();
                await this.loadRecentActivity();
                await this.loadLowStockProducts();
                await this.initCharts(); 
            }

            updateCurrentDate() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                document.getElementById('currentDate').textContent = 
                    now.toLocaleDateString('es-ES', options);
            }

            initEventListeners() {
                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                
                // Test buttons
                document.getElementById('testAuthBtn').addEventListener('click', () => this.testAuth());
                document.getElementById('testFirestoreBtn').addEventListener('click', () => this.testFirestore());
                document.getElementById('refreshDataBtn').addEventListener('click', () => this.refreshData());
                
                // Navigation links - Solo los que no tienen p√°gina espec√≠fica mostrar√°n alerta
                const navLinks = ['tiendaLink', 'clientesLink'];
                
                navLinks.forEach(linkId => {
                    const element = document.getElementById(linkId);
                    if (element) {
                        element.addEventListener('click', (e) => {
                            e.preventDefault();
                            alert(`üöß ${this.getLinkName(linkId)} - Esta funcionalidad est√° en desarrollo... kaizen`);
                        });
                    }
                });

                // Quick Actions
                document.getElementById('addProductBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = 'inventario.html';
                });

                document.getElementById('newSaleBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = 'ventas.html';
                });

                document.getElementById('viewInventoryBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = 'inventario.html';
                });

                document.getElementById('reportsBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = 'reportes.html';
                });

                // Responsive sidebar toggle
                document.getElementById('sidebarToggle').addEventListener('click', () => this.toggleSidebar());
                document.getElementById('overlay').addEventListener('click', () => this.toggleSidebar());

                // Cerrar sidebar al hacer clic en un enlace (en m√≥vil)
                const sidebarLinks = document.querySelectorAll('.sidebar .nav-link');
                sidebarLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        if (window.innerWidth <= 992) {
                            this.toggleSidebar();
                        }
                    });
                });

                // Cerrar sidebar al redimensionar la ventana si se hace m√°s grande
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 992) {
                        const sidebar = document.getElementById('sidebar');
                        const overlay = document.getElementById('overlay');
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                        document.body.classList.remove('sidebar-open');
                    }
                });
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('overlay');
                const isOpening = !sidebar.classList.contains('active');
                
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                
                if (isOpening) {
                    document.body.classList.add('sidebar-open');
                } else {
                    document.body.classList.remove('sidebar-open');
                }
            }

            // Agrega esta funci√≥n auxiliar para obtener nombres de enlaces
            getLinkName(linkId) {
                const linkNames = {
                    'tiendaLink': 'Tienda Online',
                    'clientesLink': 'Gesti√≥n de Clientes',
                    'inventarioLink': 'Inventario',
                    'ventasLink': 'Registro de Ventas',
                    'productosLink': 'Agregar Producto',
                    'reportesLink': 'Reportes'
                };
                return linkNames[linkId] || linkId;
            }

            async checkAuth() {
                console.log("üîê Verificando autenticaci√≥n...");
                
                return new Promise((resolve) => {
                    onAuthStateChanged(this.auth, (user) => {
                        const authStatus = document.getElementById('authStatus');
                        
                        if (user) {
                            console.log("‚úÖ Usuario autenticado:", user);
                            authStatus.className = 'alert alert-success';
                            authStatus.innerHTML = `
                                <strong>‚úÖ CONECTADO</strong><br>
                                Email: ${user.email}<br>
                                UID: ${user.uid}
                            `;
                            this.displayUserInfo(user);
                            resolve(true);
                        } else {
                            console.log("‚ùå No hay usuario autenticado");
                            authStatus.className = 'alert alert-danger';
                            authStatus.innerHTML = `
                                <strong>‚ùå NO AUTENTICADO</strong><br>
                                Redirigiendo al login...
                            `;
                            
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 2000);
                            resolve(false);
                        }
                    });
                });
            }

            displayUserInfo(user) {
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                const welcomeMessage = document.getElementById('welcomeMessage');
                const welcomeTitle = document.getElementById('welcomeTitle');
                
                const email = user.email;
                const displayName = user.displayName || email.split('@')[0];
                
                userName.textContent = displayName;
                
                
                welcomeTitle.textContent = `¬°Bienvenido, ${displayName}!`;
                welcomeMessage.textContent = `Est√°s conectado como ${email}. Gestiona tu tienda desde aqu√≠.`;
            }

            async testFirestoreConnection() {
                try {
                    const firestoreStatus = document.getElementById('firestoreStatus');
                    firestoreStatus.className = 'alert alert-warning';
                    firestoreStatus.innerHTML = 'Probando conexi√≥n...';
                    
                    const snapshot = await getDocs(collection(this.db, "productos"));
                    
                    firestoreStatus.className = 'alert alert-success';
                    firestoreStatus.innerHTML = `
                        <strong>‚úÖ FIRESTORE CONECTADO</strong><br>
                        Productos en la base de datos: ${snapshot.size}
                    `;
                    
                    console.log("‚úÖ Firestore conectado correctamente");
                    
                } catch (error) {
                    console.error("‚ùå Error conectando a Firestore:", error);
                    const firestoreStatus = document.getElementById('firestoreStatus');
                    
                    if (error.code === 'permission-denied') {
                        firestoreStatus.className = 'alert alert-danger';
                        firestoreStatus.innerHTML = `
                            <strong>‚ùå PERMISO DENEGADO</strong><br>
                            Las reglas de Firestore est√°n bloqueando el acceso.<br>
                            <small>Error: ${error.message}</small>
                        `;
                    } else {
                        firestoreStatus.className = 'alert alert-danger';
                        firestoreStatus.innerHTML = `
                            <strong>‚ùå ERROR EN FIRESTORE</strong><br>
                            ${error.message}
                        `;
                    }
                }
            }

            async logout() {
                try {
                    await signOut(this.auth);
                    console.log("‚úÖ Sesi√≥n cerrada exitosamente");
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('‚ùå Error al cerrar sesi√≥n:', error);
                    alert('Error al cerrar sesi√≥n: ' + error.message);
                }
            }

            async testAuth() {
                const user = this.auth.currentUser;
                if (user) {
                    alert(`‚úÖ Autenticaci√≥n funcionando\nUsuario: ${user.email}\nUID: ${user.uid}`);
                } else {
                    alert('‚ùå No hay usuario autenticado');
                }
            }

            async testFirestore() {
                try {
                    const testProduct = {
                        nombre: "Producto Test " + new Date().toLocaleTimeString(),
                        descripcion: "Producto de prueba creado desde el dashboard",
                        precio: Math.random() * 100 + 10,
                        cantidad: Math.floor(Math.random() * 50) + 1,
                        categoria: "pruebas",
                        activo: true,
                        fecha_creacion: new Date()
                    };

                    const docRef = await addDoc(collection(this.db, "productos"), testProduct);
                    alert(`‚úÖ Producto de prueba creado exitosamente\nID: ${docRef.id}\nNombre: ${testProduct.nombre}`);
                    
                    await this.loadStatistics();
                    await this.loadLowStockProducts();
                    
                } catch (error) {
                    console.error("‚ùå Error creando producto de prueba:", error);
                    alert("‚ùå Error: " + error.message);
                }
            }

            async refreshData() {
                try {
                    await this.loadStatistics();
                    await this.loadRecentActivity();
                    await this.loadLowStockProducts();
                    
                    // Actualizar gr√°ficos
                    if (this.salesChart) this.salesChart.destroy();
                    if (this.categoryChart) this.categoryChart.destroy();
                    await this.initCharts();
                    
                    alert('‚úÖ Datos actualizados correctamente');
                } catch (error) {
                    console.error('‚ùå Error actualizando datos:', error);
                    alert('Error actualizando datos: ' + error.message);
                }
            }

            async loadStatistics() {
                try {
                    // Total productos
                    const productsSnapshot = await getDocs(collection(this.db, "productos"));
                    const totalProductos = productsSnapshot.size;
                    document.getElementById('totalProductos').textContent = totalProductos;

                    // Productos con stock bajo
                    const lowStockQuery = query(
                        collection(this.db, "productos"), 
                        where("cantidad", "<", 5)
                    );
                    const lowStockSnapshot = await getDocs(lowStockQuery);
                    document.getElementById('stockBajo').textContent = lowStockSnapshot.size;

                    // Ventas del mes actual
                    const now = new Date();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const ventasQuery = query(
                        collection(this.db, "ventas"),
                        where("fecha_venta", ">=", startOfMonth)
                    );
                    const ventasSnapshot = await getDocs(ventasQuery);
                    const totalVentas = ventasSnapshot.size;
                    document.getElementById('totalVentas').textContent = totalVentas;

                    // Ingresos totales del mes
                    let ingresosTotales = 0;
                    ventasSnapshot.forEach(doc => {
                        const venta = doc.data();
                        ingresosTotales += venta.total || 0;
                    });
                    document.getElementById('ingresosTotales').textContent = `$${ingresosTotales.toFixed(2)}`;

                } catch (error) {
                    console.error("‚ùå Error cargando estad√≠sticas:", error);
                    // En caso de error, mostrar ceros
                    document.getElementById('totalVentas').textContent = '0';
                    document.getElementById('ingresosTotales').textContent = '$0';
                }
            }

            async loadRecentActivity() {
                try {
                    const container = document.getElementById('recentActivity');
                    
                    // Obtener las √∫ltimas ventas y productos como actividad
                    const ventasQuery = query(
                        collection(this.db, "ventas"),
                        orderBy("fecha_venta", "desc"),
                        limit(5)
                    );
                    
                    const productosQuery = query(
                        collection(this.db, "productos"),
                        orderBy("fecha_registro", "desc"),
                        limit(3)
                    );

                    const [ventasSnapshot, productosSnapshot] = await Promise.all([
                        getDocs(ventasQuery),
                        getDocs(productosQuery)
                    ]);

                    const activities = [];

                    // Agregar ventas recientes
                    ventasSnapshot.forEach(doc => {
                        const venta = doc.data();
                        activities.push({
                            type: 'sale',
                            title: `Venta registrada - $${venta.total?.toFixed(2) || '0.00'}`,
                            time: this.formatTimeAgo(venta.fecha_venta?.toDate()),
                            fecha: venta.fecha_venta?.toDate()
                        });
                    });

                    // Agregar productos recientes
                    productosSnapshot.forEach(doc => {
                        const producto = doc.data();
                        activities.push({
                            type: 'product',
                            title: `Producto agregado: ${producto.nombre}`,
                            time: this.formatTimeAgo(producto.fecha_registro?.toDate()),
                            fecha: producto.fecha_registro?.toDate()
                        });
                    });

                    // Ordenar por fecha (m√°s reciente primero) y limitar a 5
                    activities.sort((a, b) => b.fecha - a.fecha);
                    const recentActivities = activities.slice(0, 5);

                    if (recentActivities.length === 0) {
                        container.innerHTML = '<p class="text-center text-muted">No hay actividad reciente</p>';
                        return;
                    }

                    container.innerHTML = recentActivities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-${this.getActivityIcon(activity.type)}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.title}</div>
                                <div class="activity-time">${activity.time}</div>
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error("‚ùå Error cargando actividad:", error);
                    const container = document.getElementById('recentActivity');
                    container.innerHTML = '<p class="text-center text-muted">Error cargando actividad</p>';
                }
            }

            // Agrega esta funci√≥n auxiliar para formatear el tiempo
            formatTimeAgo(date) {
                if (!date) return 'Fecha desconocida';
                
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Hace unos segundos';
                if (diffMins < 60) return `Hace ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
                if (diffHours < 24) return `Hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
                if (diffDays < 7) return `Hace ${diffDays} d√≠a${diffDays > 1 ? 's' : ''}`;
                
                return date.toLocaleDateString('es-ES');
            }

            getActivityIcon(type) {
                const icons = {
                    'sale': 'shopping-cart',
                    'product': 'box',
                    'user': 'user-plus',
                    'update': 'sync'
                };
                return icons[type] || 'info-circle';
            }

            async loadLowStockProducts() {
                try {
                    const lowStockQuery = query(
                        collection(this.db, "productos"), 
                        where("cantidad", "<", 5),
                        orderBy("cantidad", "asc"),
                        limit(5)
                    );
                    
                    const snapshot = await getDocs(lowStockQuery);
                    const container = document.getElementById('lowStockProducts');
                    
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-center text-muted">No hay productos con stock bajo</p>';
                        return;
                    }

                    container.innerHTML = '';
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        const item = document.createElement('div');
                        item.className = 'activity-item';
                        item.innerHTML = `
                            <div class="activity-icon" style="background: #ffebee;">
                                <i class="fas fa-exclamation-triangle" style="color: #f44336;"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${product.nombre}</div>
                                <div class="activity-time">Stock: ${product.cantidad} unidades - $${(product.precio || 0).toFixed(2)}</div>
                            </div>
                        `;
                        container.appendChild(item);
                    });

                } catch (error) {
                    console.error("‚ùå Error cargando productos con stock bajo:", error);
                    const container = document.getElementById('lowStockProducts');
                    container.innerHTML = '<p class="text-center text-muted">Error cargando productos</p>';
                }
            }

            async initCharts() {
                await this.loadSalesChart();
                await this.loadCategoryChart();
            }

            async loadSalesChart() {
                try {
                    // Obtener ventas de los √∫ltimos 7 d√≠as
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    
                    const ventasQuery = query(
                        collection(this.db, "ventas"),
                        where("fecha_venta", ">=", sevenDaysAgo),
                        orderBy("fecha_venta", "asc")
                    );
                    
                    const snapshot = await getDocs(ventasQuery);
                    
                    // Preparar datos para los √∫ltimos 7 d√≠as
                    const dates = [];
                    const salesData = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        dates.push(this.formatChartDate(date));
                        
                        // Calcular total de ventas para este d√≠a
                        let dailyTotal = 0;
                        snapshot.forEach(doc => {
                            const venta = doc.data();
                            const ventaDate = venta.fecha_venta?.toDate();
                            if (ventaDate && ventaDate.toISOString().split('T')[0] === dateStr) {
                                dailyTotal += venta.total || 0;
                            }
                        });
                        salesData.push(dailyTotal);
                    }

                    // Verificar si hay datos de ventas
                    const hasSalesData = salesData.some(amount => amount > 0);

                    // Gr√°fico de ventas
                    const salesCtx = document.getElementById('salesChart').getContext('2d');
                    
                    if (this.salesChart) {
                        this.salesChart.destroy();
                    }

                    this.salesChart = new Chart(salesCtx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Ventas ($)',
                                data: salesData,
                                borderColor: '#ff85a2',
                                backgroundColor: hasSalesData ? 'rgba(255, 133, 162, 0.1)' : 'rgba(0,0,0,0.02)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: !hasSalesData,
                                    text: 'No hay datos de ventas en los √∫ltimos 7 d√≠as'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error("‚ùå Error cargando gr√°fico de ventas:", error);
                    // Gr√°fico vac√≠o en caso de error
                    this.createEmptySalesChart();
                }
            }

            async loadCategoryChart() {
                try {
                    const productsSnapshot = await getDocs(collection(this.db, "productos"));
                    
                    // Contar productos por categor√≠a
                    const categoryCount = {};
                    productsSnapshot.forEach(doc => {
                        const product = doc.data();
                        const categoria = product.categoria || 'general';
                        categoryCount[categoria] = (categoryCount[categoria] || 0) + 1;
                    });

                    const labels = Object.keys(categoryCount);
                    const data = Object.values(categoryCount);

                    // Verificar si hay productos
                    const hasProducts = labels.length > 0;

                    // Gr√°fico de categor√≠as
                    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                    
                    if (this.categoryChart) {
                        this.categoryChart.destroy();
                    }

                    this.categoryChart = new Chart(categoryCtx, {
                        type: 'doughnut',
                        data: {
                            labels: hasProducts ? labels.map(cat => this.getCategoriaNombre(cat)) : ['Sin productos'],
                            datasets: [{
                                data: hasProducts ? data : [1],
                                backgroundColor: hasProducts ? [
                                     '#ff85a2', // Rosa
    '#36a2eb', // Azul
    '#ffce56', // Amarillo
    '#4bc0c0', // Turquesa
    '#9966ff', // P√∫rpura
    '#ff9f40'  // Naranja
                                ] : ['#ccc'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                title: {
                                    display: !hasProducts,
                                    text: 'No hay productos registrados'
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error("‚ùå Error cargando gr√°fico de categor√≠as:", error);
                    // Gr√°fico vac√≠o en caso de error
                    this.createEmptyCategoryChart();
                }
            }




            // Funciones auxiliares para gr√°ficos vac√≠os
            createEmptySalesChart() {
                const salesCtx = document.getElementById('salesChart').getContext('2d');
                
                if (this.salesChart) {
                    this.salesChart.destroy();
                }
                
                this.salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                        datasets: [{
                            label: 'Ventas ($)',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#ccc',
                            backgroundColor: 'rgba(0,0,0,0.02)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Error cargando datos de ventas'
                            }
                        }
                    }
                });
            }

            createEmptyCategoryChart() {
                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                
                if (this.categoryChart) {
                    this.categoryChart.destroy();
                }
                
                this.categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Error'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#ccc'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Error cargando categor√≠as'
                            }
                        }
                    }
                });
            }

            // Funci√≥n auxiliar para formatear fechas del gr√°fico
            formatChartDate(date) {
                return date.toLocaleDateString('es-ES', { weekday: 'short' });
            }

            // Funci√≥n auxiliar para nombres de categor√≠a (debe coincidir con la de inventario)
            getCategoriaNombre(categoria) {
                const categorias = {
                    'ropa': 'Ropa Deportiva',
                    'calzado': 'Calzado',
                    'accesorios': 'Accesorios',
                    'equipamiento': 'Equipamiento',
                    'suplementos': 'Suplementos',
                    'general': 'General'
                };
                return categorias[categoria] || categoria;
            }
        }

        // Inicializar el dashboard cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new Dashboard();
        });
    </script>
    <script>


// Detectar cuando hay una nueva versi√≥n del Service Worker
let newServiceWorker = null;

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('controllerchange', function() {
        console.log('üîÑ Controller changed - recargando p√°gina');
        window.location.reload();
    });
    
    // Escuchar mensajes del Service Worker
    navigator.serviceWorker.addEventListener('message', event => {
        if (event.data && event.data.type === 'NEW_VERSION') {
            console.log('üÜï Nueva versi√≥n disponible');
            if (confirm('¬°Hay una nueva versi√≥n disponible! ¬øQuieres actualizar ahora?')) {
                window.location.reload();
            }
        }
    });
}


// Service Worker para todas las p√°ginas
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
        .then(reg => {
            console.log('‚úÖ SW registrado en dashboard - NUEVA VERSI√ìN');
            
            // üî• FORZAR ACTUALIZACI√ìN INMEDIATA
            reg.update().then(() => {
                console.log('üîÑ Service Worker actualizado');
                
                // Notificar al SW para que se active inmediatamente
                if (reg.waiting) {
                    reg.waiting.postMessage({type: 'SKIP_WAITING'});
                }
            });
        })
        .catch(err => console.log('‚ùå Error SW:', err));
}

// Detectar modo standalone (PWA instalada)
if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('üì± Ejecut√°ndose como PWA');
    document.body.classList.add('pwa-mode');
}
</script>

</body>
</html>